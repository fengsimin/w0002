<?php
 class MysqlBackup { private $conn; private $dbname; private $sqlname = ''; private $path = '../data/backup/sql'; function __construct($config) { $this->dbname = $config['name']; $this->conn = mysql_connect($config['host'], $config['user'], $config['pass']); mysql_select_db($this->dbname, $this->conn); mysql_query("SET NAMES 'utf8'"); } public function setPath($path) { $this->path = $path; } public function setName($name) { $this->sqlname = $name; } public function getName() { return $this->sqlname; } public function query($sql) { mysql_query($sql); } public function export($issave = true) { $tables = mysql_query('SHOW TABLES FROM `'.$this->dbname.'`'); while ($row = mysql_fetch_row($tables)) { $table = $row[0]; $result = mysql_query('SELECT * FROM '.$table); $num_fields = mysql_num_fields($result); $sqls.= 'DROP TABLE IF EXISTS `'.$table.'`;'; $row2 = mysql_fetch_row(mysql_query('SHOW CREATE TABLE '.$table)); $sqls.= "\n".$row2[1].";\n\n"; for ($i = 0; $i < $num_fields; $i++) { while ($row = mysql_fetch_row($result)) { $sqls.= 'INSERT INTO `'.$table.'` VALUES('; for ($j = 0; $j < $num_fields; $j++) { $row[$j] = addslashes($row[$j]); $row[$j] = str_replace("\n","\\n", $row[$j]); if (isset($row[$j])) { $sqls.= '"'.$row[$j].'"' ; } else { $sqls.= '""'; } if ($j<($num_fields-1)) { $sqls.= ','; } } $sqls.= ");\n"; } } $sqls.="\n\n"; } if ($issave==true) { if (!is_dir($this->path)) { mkdir($this->path, 0755, true); } if (!$this->sqlname) { $this->sqlname = date('YmdHis',time()).'.sql'; } $handle = fopen($this->path.'/'.$this->sqlname, 'w+'); if (fwrite($handle, $sqls)) { return true; } else { return false; } fclose($handle); } else { return $sqls; } } public function import($name) { $errors = array(); $sqlname = $this->path . '/' . $name; if( is_file($sqlname) ) { $file = fopen($sqlname, "r"); $file_str = fread($file, filesize($sqlname)); } $sqls = explode(";\n", $file_str); foreach ($sqls as $sql) { if (!trim($sql)) { continue; } if (!mysql_query($sql)) { $errors[] = $sql; } } return $errors; } }